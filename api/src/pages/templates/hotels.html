{% extends "base.html" %}

{% block title %} Список отелей {% endblock %}

{% block content %}
<style>
    .hotel-grid {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 20px;
        margin-top: 7px;
    }
    .hotel {
        width: 30%;
        box-sizing: border-box;
        border: 3px solid #000000;
        padding: 20px;
        text-align: center;
        background-color: rgb(94, 153, 174);
        cursor: pointer;
        text-decoration: none; 
        color: inherit; 
    }
    .hotel img {
        max-width: 100%;
        height: auto;
    }
</style>

<div class="hotel-grid">
    {% for hotel in hotels %}
        <a href="/pages/hotel/{{ hotel.id }}" class="hotel">
            <img src="{{ hotel.photo }}" alt="Отель {{ hotel.id }}">
            <h3>{{ hotel.name }}</h3>
            <p>{{ hotel.description }}</p>
        </a>
    {% endfor %}
</div>

<script>
    async function sendRequest() {
        let token = localStorage.getItem('token') || sessionStorage.getItem('token');

        if (token === null) {
            window.location.href = '/pages/login';
            return;
        }

        const response = await fetch('/api/v1/check_token', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'auth': token,
            }
        });

        if (response.status === 401) {
            let rt = localStorage.getItem('refresh_token') || sessionStorage.getItem('refresh_token')

            console.log(rt);

            if (rt === null) {
                localStorage.clear();
                window.location.href = '/pages/login';
                return;
            }

            const rtResponse = await fetch('/api/v1/auth/refresh', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'token': rt,
                }
            });

            if (rtResponse.ok) {
                const data = await rtResponse.json();
                localStorage.clear();
                sessionStorage.clear();
                localStorage.setItem('token', data.token);
                localStorage.setItem('refresh_token', data.refresh_token);
                sessionStorage.setItem('token', data.token);
                sessionStorage.setItem('refresh_token', data.refresh_token);
            } else {
                localStorage.clear();
                sessionStorage.clear();
                window.location.href = '/pages/login';
            }
        }
    }

    window.onload = function() {
        sendRequest();
    };
</script>

{% endblock %}
